// Generated by CoffeeScript 1.4.0
(function() {
  var bind, _;

  _ = this._ || require('underscore');

  (typeof module !== "undefined" && module !== null ? module : {}).exports = bind = function(Backbone) {
    var getCtor, hasMany, hasManyVia, hasOne, hook, initialize, _base;
    getCtor = function(val) {
      if (val instanceof Backbone.Model) {
        return val;
      } else {
        return val();
      }
    };
    hook = function(model) {
      var get, name, rel, set, _ref, _ref1, _ref2, _results;
      if (!model.relations) {
        return;
      }
      _ref = [
        model.get, function() {
          return get.apply(model, arguments);
        }
      ], get = _ref[0], model.get = _ref[1];
      _ref1 = [
        model.set, function() {
          return set.apply(model, arguments);
        }
      ], set = _ref1[0], model.set = _ref1[1];
      _ref2 = model.relations;
      _results = [];
      for (name in _ref2) {
        rel = _ref2[name];
        if (rel.hasOne) {
          _results.push(hasOne(model, name, rel));
        } else if (rel.via) {
          _results.push(hasManyVia(model, name, rel));
        } else {
          _results.push(hasMany(model, name, rel));
        }
      }
      return _results;
    };
    hasOne = function(model, name, rel) {
      var ctor, mine, onChangeId, onChangeMine, onDestroy;
      ctor = getCtor(rel.hasOne);
      mine = rel.myFk;
      onChangeId = function(other) {
        return model.set(mine, other != null ? other.id : void 0);
      };
      onDestroy = function() {
        delete model.get[name];
        if (rel.romeo) {
          return model.trigger('destroy', model, model.collection);
        } else {
          return model.set(mine, null);
        }
      };
      model.set[name] = function(next) {
        var prev;
        prev = model.get[name];
        if (next === prev) {
          return;
        }
        if (prev) {
          prev.off('change:id', onChangeId);
          prev.off('destroy', onDestroy);
        }
        model.get[name] = next;
        model.set(mine, next != null ? next.id : void 0);
        if (next) {
          next.on('change:id', onChangeId);
          return next.on('destroy', onDestroy);
        }
      };
      (onChangeMine = function() {
        return model.set[name](ctor.cache().get(model.get(mine)));
      })();
      model.on("change:" + mine, onChangeMine);
      return ctor.cache().on('add', function(other) {
        if (other.id == model.get(mine)) {
          return model.set[name](other);
        }
      });
    };
    hasMany = function(model, name, rel) {
      var ctor, models, theirs,
        _this = this;
      ctor = getCtor(rel.hasMany);
      theirs = rel.theirFk;
      models = model.get[name] = new ctor.Collection;
      models.url = function() {
        return "" + (_.result(model, 'url')) + (_.result(rel, 'url') || ("/" + name));
      };
      (models.filters = {})[theirs] = model;
      ctor.cache().on("add change:" + theirs, function(other) {
        if (!(other != null ? other.id : void 0)) {
          return;
        }
        if (model.id == other.get(theirs)) {
          return models.add(other);
        }
      });
      models.on("change:" + theirs, function(other) {
        return models.remove(other);
      });
      return models.add(ctor.cache().filter(function(other) {
        if (!other.id) {
          return;
        }
        return model.id == other.get(theirs);
      }));
    };
    hasManyVia = function(model, name, rel) {
      var attrs, ctor, mine, models, theirs, via, viaCtor,
        _this = this;
      ctor = getCtor(rel.hasMany);
      viaCtor = getCtor(rel.via);
      mine = rel.myViaFk;
      theirs = rel.theirViaFk;
      models = model.get[name] = new ctor.Collection;
      models.url = function() {
        return "" + (_.result(model, 'url')) + (_.result(rel, 'url') || ("/" + name));
      };
      models.mine = theirs;
      via = models.via = new viaCtor.Collection;
      via.url = function() {
        return "" + (_.result(model, 'url')) + (_.result(viaCtor.Collection.prototype, 'url'));
      };
      (via.filters = {})[mine] = model;
      attrs = {};
      viaCtor.cache().on('add', function(other) {
        if (model.id && model.id == other.get(mine)) {
          return via.add(other);
        }
      });
      via.on('add', function(other) {
        if (!other.get(theirs)) {
          return;
        }
        return models.add(ctor["new"]({
          id: other.get(theirs)
        }));
      }).on('remove', function(other) {
        return models.remove(models.get(other.get(theirs)));
      });
      ctor.cache().on('add', function(other) {
        if (!(attrs[mine] = model.id)) {
          return;
        }
        if (!(attrs[theirs] = other.id)) {
          return;
        }
        if (via.get(viaCtor.prototype._generateId(attrs))) {
          return models.add(other);
        }
      });
      models.on('add', function(other) {
        if (!(attrs[mine] = model.id)) {
          return;
        }
        if (!(attrs[theirs] = other.id)) {
          return;
        }
        return via.add(viaCtor["new"](attrs));
      }).on('remove', function(other) {
        attrs[mine] = model.id;
        attrs[theirs] = other.id;
        return via.remove(via.get(viaCtor.prototype._generateId(attrs)));
      });
      return via.add(viaCtor.cache().filter(function(other) {
        return model.id && model.id == other.get(mine);
      }));
    };
    _.extend(Backbone.Model, {
      cache: function() {
        return this._cache || (this._cache = new this.Collection);
      },
      "new": function(attrs) {
        var model;
        model = this.cache().get(this.prototype._generateId(attrs));
        return (model != null ? model.set.apply(model, arguments) : void 0) || (function(func, args, ctor) {
          ctor.prototype = func.prototype;
          var child = new ctor, result = func.apply(child, args);
          return Object(result) === result ? result : child;
        })(this, arguments, function(){});
      }
    });
    initialize = Backbone.Model.prototype.initialize;
    _.extend(Backbone.Model.prototype, {
      initialize: function() {
        initialize.apply(this, arguments);
        if (this.cacheAll) {
          this.constructor.cache().add(this);
        }
        return hook(this);
      },
      via: function(rel, id) {
        var attrs, viaCtor;
        if (!(id = (id != null ? id.id : void 0) || id)) {
          return;
        }
        viaCtor = getCtor(this.relations[rel].via);
        (attrs = {})[this.relations[rel].myViaFk] = this.id;
        attrs[this.relations[rel].theirViaFk] = id;
        return this.get[rel].via.get(viaCtor.prototype._generateId(attrs));
      }
    });
    (_base = Backbone.Model.prototype)._generateId || (_base._generateId = function(attrs) {
      if (attrs == null) {
        attrs = this.attributes;
      }
      return attrs[this.idAttribute];
    });
    return Backbone;
  };

  if (this.Backbone) {
    bind(Backbone);
  }

}).call(this);
